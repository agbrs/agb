name: Rust

on:
  merge_group:
  push:
    branches: [master]
  pull_request:
    branches: [master]
  schedule:
    - cron: "10 6 * * *"

env:
  CARGO_TERM_COLOR: always
  # RUSTUP_TOOLCHAIN: ${{ !github.event.schedule && 'nightly-2025-04-25' || 'nightly' }}
  # RUSTUP_TOOLCHAIN: "nightly"

jobs:
  build:
    name: Run checks
    strategy:
      matrix:
        make_target:
          [
            "test/agb",
            "release/test/agb",
            "arm/test/agb",
            "release/arm/test/agb",
            "no-features/build/agb",
            "test-native",
            "doc-check",
            "spellcheck book",
            "miri/agb-hashmap",
            "all/fmt-check all/lint",
          ]
    runs-on: ubuntu-24.04
    steps:
      - name: Install build tools
        run: sudo apt-get update && sudo apt-get install build-essential libelf-dev zip libasound-dev -y
      - uses: actions/checkout@v4
      - name: Setup mdBook
        uses: peaceiris/actions-mdbook@v2
        with:
          mdbook-version: "0.4.13"
      - name: Run checks
        run: make -j ${{ matrix.make_target }} -kO
